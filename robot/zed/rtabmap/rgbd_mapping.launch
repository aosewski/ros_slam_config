<launch>

  <arg name="zed_namespace"/>
  <arg name="base_frame_id"/>

  <!-- ZED TOPICS -->
  <arg name="zed_rgb_topic"           default="/$(arg zed_namespace)/rgb/image_rect_color"/>
  <arg name="zed_depth_topic"         default="/$(arg zed_namespace)/depth/depth_registered"/>
  <arg name="zed_camera_info_topic"   default="/$(arg zed_namespace)/rgb/camera_info"/>
  <arg name="zed_odom_topic"          default="/$(arg zed_namespace)/odom"/>

  <!-- ===================================================================== -->

  <!-- RTAB_MAP ARGUMENTS -->
   
  <!-- Corresponding config files -->
  <!-- To change RTAB-Map's parameters, set the path of config file (*.ini) 
       generated by the standalone app -->
  <arg name="cfg"                     default="" /> 

  <!-- Fixed frame id, you may set "base_link" or "base_footprint" if they 
       are published -->
  <arg name="frame_id"                default="$(arg base_frame_id)"/>
  <!-- If set, TF is used to get odometry instead of the topic -->
  <arg name="odom_frame_id"           default=""/>
  <arg name="map_frame_id"            default="map"/>
  <arg name="rtabmap_namespace"       default="rtabmap"/>
  <arg name="database_path"           default="~/.ros/rtabmap.db"/>
  <arg name="queue_size"              default="10"/>
  <arg name="wait_for_transform"      default="0.2"/>
  <!-- delete_db_on_start, udebug -->
  <arg name="args"                    default="--delete_db_on_start"/>
  <!-- for debugging purpose, it fills launch-prefix tag of the nodes -->
  <arg name="launch_prefix"           default=""/>

  <!-- if timestamps of the input topics are synchronized using approximate 
       or exact time policy-->
  <arg name="approx_sync"             default="false"/>         
   
  <!-- RGB-D related topics -->
  <arg name="rgb_topic"               default="$(arg zed_rgb_topic)" />
  <arg name="depth_topic"             default="$(arg zed_depth_topic)" />
  <arg name="camera_info_topic"       default="$(arg zed_camera_info_topic)" />

  <!-- If you want to subscribe to compressed image topics -->
  <arg name="compressed"              default="false"/>
  <!-- Common types: compressed, theora (see "rosrun image_transport list_transports") -->
  <arg name="rgb_image_transport"     default="compressed"/>    
  <!-- Common types: compressed, theora (see "rosrun image_transport list_transports") -->
  <arg name="depth_image_transport"   default="compressedDepth"/>  
   
  <arg name="subscribe_scan"          default="false"/>
  <arg name="scan_topic"              default="/scan"/>

  <arg name="subscribe_scan_cloud"    default="false"/>
  <arg name="scan_cloud_topic"        default="/scan_cloud"/>
   
  <!-- Launch rtabmap visual odometry node -->
  <arg name="visual_odometry"          default="false"/>
  <!-- Odometry topic used if visual_odometry is false -->
  <arg name="odom_topic"               default="$(arg zed_odom_topic)"/>
  <arg name="vo_frame_id"              default="odom"/>
  <!-- If TF is used to get odometry, this is the default angular variance -->
  <arg name="odom_tf_angular_variance" default="1"/>
  <!-- If TF is used to get odometry, this is the default linear variance -->
  <arg name="odom_tf_linear_variance"  default="1"/>
  <arg name="odom_args"                default="$(arg args)"/>

  <!-- These arguments should not be modified directly, see referred topics without "_relay" suffix above -->
  <arg     if="$(arg compressed)" name="rgb_topic_relay"           default="$(arg rgb_topic)_relay"/>
  <arg unless="$(arg compressed)" name="rgb_topic_relay"           default="$(arg rgb_topic)"/>
  <arg     if="$(arg compressed)" name="depth_topic_relay"         default="$(arg depth_topic)_relay"/>
  <arg unless="$(arg compressed)" name="depth_topic_relay"         default="$(arg depth_topic)"/>

  <!-- ===================================================================== -->
  <!-- RTAB_MAP ODOMETRY CONFIGURATION -->
  <!--  -"strategy"        : Strategy: Frame-to-Map 1=Frame-To-Frame
        -"feature"         : Feature type: 0=SURF 1=SIFT 2=ORB 3=FAST/FREAK 
                              4=FAST/BRIEF 5=GFTT/FREAK 6=GFTT/BRIEF 7=BRISK
        -"nn"              : Nearest neighbor strategy : 0=Linear, 1=FLANN_KDTREE, 
                              2=FLANN_LSH, 3=BRUTEFORCE 4=BRUTEFORCE_GPU
                             Set to 1 for float descriptor like SIFT/SURF                  
                             Set to 3 for binary descriptor like ORB/FREAK/BRIEF/BRISK  
        -"max_depth"       : Maximum features depth (m)  
        -"min_inliers"     : Minimum visual correspondences to accept a transformation (m) 
        -"inlier_distance" : RANSAC maximum inliers distance (m)  
        -"local_map"       : Local map size: number of unique features to keep track 
        -"odom_info_data"  : Fill odometry info messages with inliers/outliers data.
        -"correspondence"  : 0=Features Matching, 1=Optical Flow 
        -"feature_win_size": Matching window size (pixels) around projected points -->
  <!-- ===================================================================== -->
  <arg name="strategy"              default="1"/>
  <arg name="feature"               default="6"/>
  <arg name="nn"                    default="3"/>
  <arg name="max_depth"             default="10"/>
  <arg name="min_inliers"           default="15"/>
  <arg name="inlier_distance"       default="0.1"/>
  <arg name="feature_win_size"      default="40"/>
  <arg name="local_map"             default="1000"/>
  <arg name="vis_reg_max_features"  default="1000"/>
  <arg name="gftt_min_distance"     default="7"/>
  <arg name="correspondence"        default="0"/>
  <!--Motion estimation approach: 0:3D->3D, 1:3D->2D (PnP), 2:2D->2D (Epipolar 
      Geometry)-->
  <arg name="motion_estimation"       default="0"/>
  <arg name="img_vocabulary_size"     default="400"/>

  <!-- Use subpixel feature refinement -->
  <arg name="subpix_ref"         default="false"/>
  <!-- Test configuration for better loop closure detection -->
  <arg name="closure_detection"  default="false"/>
  <!-- Whether or not to perform robust graph optimization -->
  <arg name="robust_graph_optim" default="false"/>

  <!-- Nodes -->
  <group ns="$(arg rtabmap_namespace)">

    <!-- RGB-D Odometry -->
    <node if="$(arg compressed)" name="republish_rgb" type="republish" 
          pkg="image_transport" args="$(arg rgb_image_transport) in:=$(arg rgb_topic) raw out:=$(arg rgb_topic_relay)"/>
    <node if="$(arg compressed)" name="republish_depth" type="republish" 
          pkg="image_transport" args="$(arg depth_image_transport) in:=$(arg depth_topic) raw out:=$(arg depth_topic_relay)"/>

    <node if="$(arg visual_odometry)" pkg="rtabmap_ros" type="rgbd_odometry" 
          name="rgbd_odometry" output="screen" args="$(arg odom_args)" 
          launch-prefix="$(arg launch_prefix)">
      <remap from="rgb/image"       to="$(arg rgb_topic_relay)"/>
      <remap from="depth/image"     to="$(arg depth_topic_relay)"/>
      <remap from="rgb/camera_info" to="$(arg camera_info_topic)"/>

      <param name="frame_id"                    type="str"    value="$(arg frame_id)"/>
      <param name="odom_frame_id"               type="str"    value="$(arg vo_frame_id)"/>
      <param name="wait_for_transform_duration" type="double" value="$(arg wait_for_transform)"/>
      <param name="approx_sync"                 type="bool"   value="$(arg approx_sync)"/>
      <param name="config_path"                 type="str"    value="$(arg cfg)"/>
      <param name="queue_size"                  type="int"    value="$(arg queue_size)"/>
      <param name="publish_tf"                  type="bool"   value="true"/>

      <param name="Odom/FillInfoData"     type="string" value="true"/>
      <param name="Odom/Strategy"         type="string" value="$(arg strategy)"/> 
      <param name="Odom/ImageDecimation"  type="string" value="-2"/>
      <!-- Visual] Maximum map size: If > 0 (example 5000), the odometry will maintain 
            a local map of X maximum features. This will decrease odometry drifting 
            when the camera is not moving -->
      <param name="OdomF2M/MaxSize"       type="string" value="$(arg local_map)"/>
      <param name="Odom/ResetCountdown"   type="int"    value="4"/>
      <param name="Odom/ImageBufferSize"  type="int"    value="5"/>

      <param name="Vis/EstimationType"    type="int"    value="$(arg motion_estimation)"/>
      <param name="Vis/FeatureType"       type="string" value="$(arg feature)"/>  
      <param name="Vis/CorType"                       value="$(arg correspondence)"/> 
      <param name="Vis/CorNNType"       type="string" value="$(arg nn)"/>
      <param name="Vis/MaxDepth"        type="string" value="$(arg max_depth)"/>  
      <param name="Vis/MinInliers"      type="string" value="$(arg min_inliers)"/> 
      <param name="Vis/InlierDistance"  type="string" value="$(arg inlier_distance)"/>
      <!-- [Vis/CorType=0] Matching window size (pixels) around projected points when a guess transform is provided to find correspondences. 0 means disabled. -->
      <param name="Vis/CorrGuessWinSize"    type="string" value="$(arg feature_win_size)"/>
      <!--Number of iterations used to refine the transformation found by RANSAC. 
          0 means that the transformation is not refined-->
      <!--<param name="Vis/RefineIterations" type="string" value="5"/>     -->
      <param name="Vis/MaxFeatures"         type="string" value="$(arg vis_reg_max_features)"/>
      <param name="GFTT/MinDistance"        type="string" value="$(arg gftt_min_distance)"/>
      <!--0=Vis, 1=Icp, 2=VisIcp-->
      <param name="Reg/Strategy"            type="int"    value="0"/>      
    </node>
    
    <!-- Visual SLAM (robot side) -->
    <!-- args: "delete_db_on_start" and "udebug" -->
    <node name="rtabmap" pkg="rtabmap_ros" type="rtabmap" output="screen" 
          args="$(arg args)" launch-prefix="$(arg launch_prefix)">
      <param name="subscribe_depth"      type="bool"   value="true"/>
      <param name="subscribe_scan"       type="bool"   value="$(arg subscribe_scan)"/>
      <param name="subscribe_scan_cloud" type="bool"   value="$(arg subscribe_scan_cloud)"/>
      <param name="frame_id"             type="str"    value="$(arg frame_id)"/>
      <param name="map_frame_id"         type="str"    value="$(arg map_frame_id)"/>
      <param name="odom_frame_id"        type="str"    value="$(arg odom_frame_id)"/>
      <param name="odom_tf_angular_variance" type="double" value="$(arg odom_tf_angular_variance)"/>
      <param name="odom_tf_linear_variance"  type="double" value="$(arg odom_tf_linear_variance)"/>
      <param name="wait_for_transform_duration"  type="double"   value="$(arg wait_for_transform)"/>
      <param name="database_path"        type="str"   value="$(arg database_path)"/>
      <param name="approx_sync"          type="bool"  value="$(arg approx_sync)"/>
      <param name="config_path"          type="str"   value="$(arg cfg)"/>
      <param name="queue_size"           type="int"   value="$(arg queue_size)"/>
      
      <remap from="rgb/image"       to="$(arg rgb_topic_relay)"/>
      <remap from="depth/image"     to="$(arg depth_topic_relay)"/>
      <remap from="rgb/camera_info" to="$(arg camera_info_topic)"/>

      <remap from="scan"            to="$(arg scan_topic)"/>
      <remap from="scan_cloud"      to="$(arg scan_cloud_topic)"/>
      <remap from="odom"            to="$(arg odom_topic)"  unless="$(arg visual_odometry)"/>

      <!-- RTAB-Map's parameters -->
      <!-- RGBD-SLAM -> Local Occupancy Grid tab: 
          [Grid/DepthDecimation=true] Decimation of the depth image before creating cloud -->
      <param name="Grid/DepthDecimation"    type="string" value="4"/>
      <param name="GFTT/MinDistance"        type="string" value="$(arg gftt_min_distance)"/>
      <!-- Image decimation (>=1) before features extraction. Negative decimation is done from RGB size instead of depth size (if depth is smaller than RGB, it may be interpolated depending of the decimation value) -->
      <param name="Mem/ImagePreDecimation"  type="string" value="-4"/>
      <!-- Image decimation (>=1) of saved data in created signatures (after features extraction). -->
      <param name="Mem/ImagePostDecimation" type="string" value="-2"/>
      <param name="Kp/DetectorStrategy"     type="string" value="$(arg feature)"/>
      <!--Memory -> Vocabulary, Feature Extraction tab
          Maximum words per image (0=no maximum). Setting to -1 will disable features 
          extraction, so disabling loop closure detection indirectly-->
      <param name="Kp/MaxFeatures"          type="string" value="$(arg img_vocabulary_size)"/>
      
      <!-- ********************************************************************* -->
      <!-- Sub pixel refinement 
           Refining features to sub pixel. Sub pixel corners may not be needed for features like SURF/SIFT, which are already sub pixel-->
      <param if="$(arg subpix_ref)" name="Kp/SubPixWinSize"        type="string" value="3"/>
      <param if="$(arg subpix_ref)" name="Kp/SubPixIterations"     type="string" value="5"/>
      <param if="$(arg subpix_ref)" name="Kp/SubPixEps"            type="string" value="0.02"/>
      <!-- ********************************************************************* -->

      <param name="Vis/EstimationType"    type="int"    value="$(arg motion_estimation)"/>
      <param name="Vis/MinInliers"        type="string" value="$(arg min_inliers)"/>
      <!-- Motion Estimation 3D -> 3D Maximum distance accepted between visual word
           correspondences. -->
      <param name="Vis/InlierDistance"    type="string" value="$(arg inlier_distance)"/>
      <param name="Vis/CorrGuessWinSize"  type="string" value="$(arg feature_win_size)"/>
      <!-- Motion Estimation -> Visual Registration tab - Max features extracted from 
           the images (0 means inf). -->
      <param name="Vis/MaxFeatures"       type="string" value="$(arg vis_reg_max_features)"/>
      <!--<param name="RGBD/AngularUpdate"  type="string" value="0.01"/>-->
      <!--<param name="RGBD/LinearUpdate"   type="string" value="0.01"/>-->

      <!--Optimize graph from the newest node. If false, the graph is optimized 
        from the oldest node of the current graph (this adds an overhead computation 
        to detect to oldest mode of the current graph, but it can be useful to preserve 
        the map referential from the oldest node). Warning when set to false: when some
        nodes are transferred, the first referential of the local map may change, 
        resulting in momentary changes in robot/map position (which are annoying in 
        teleoperation)-->
      <param name="RGBD/OptimizeFromGraphEnd" type="string" value="true"/>
      
      <!-- ********************************************************************* -->
      <!-- Loop closure detection - wiki tutorial -->

      <param name="RGBD/Enabled"              type="bool"   value="true"/>
      <!-- process all images -->
      <param name="Rtabmap/ImageBufferSize"   type="int"    value="3"/> 
      <!-- 0 means process as fast as camera publishes images -->
      <param name="Rtabmap/DetectionRate"     type="int"    value="0"/>

      <param if="$(arg closure_detection)" name="Mem/RehearsalSimilarity"   
                type="string" value="0.4"/>
      <param if="$(arg closure_detection)" name="Mem/STMSize"               
                type="int"    value="15"/>
      <!-- On merge, update to new id. When false, no copy. -->
      <param if="$(arg closure_detection)" name="Mem/RehearsalIdUpdatedToNewOne"  
                type="bool"    value="true"/>
      <!-- ignore images with little or no features -->
      <param if="$(arg closure_detection)" name="Mem/BadSignaturesIgnored"  
                type="bool"   value="true"/>
      <!-- ********************************************************************* -->

      <!-- ********************************************************************* -->
      <!-- Robust graph optimization  -->

      <!--Graph optimization strategy: 0=TORO, 1=g2o and 2=GTSAM.-->
      <param name="Optimizer/Strategy"        type="string" value="2"/>

      <param if="$(arg robust_graph_optim)"   name="Optimizer/Robust"
                type="string" value="true"/>
      <!-- Reject loop closures if optimization error is greater than this value 
          (0=disabled). This will help to detect when a wrong loop closure is added to 
          the graph. Not compatible with "Optimizer/Robust" if enabled -->
      <param if="$(arg robust_graph_optim)"   name="RGBD/OptimizeMaxError"
               type="int"  value="0"/>

      <param unless="$(arg robust_graph_optim)"   name="Optimizer/Robust"
                type="string" value="false"/>
      <param unless="$(arg robust_graph_optim)"   name="RGBD/OptimizeMaxError"
               type="int"  value="1"/>
      <!-- ********************************************************************* -->

      <!--Extract features even if there are some already in the nodes.-->
      <param name="RGBD/LoopClosureReextractFeatures" type="string" value="true"/>
      <!--0=Levenberg 1=GaussNewton 2=Dogleg
          0 -> działa znacznie lepiej niż 1 i 2-->
      <param name="GTSAM/Optimizer"     type="int"    value="1"/>

      <!--<param name="Rtabmap/TimeThr"           type="string" value="0"/>-->
      
      <!-- Create intermediate nodes if odometry is faster than the detection rate. -->
      <param name="Rtabmap/CreateIntermediateNodes"   type="bool" value="true"/>

      <param name="Mem/IncrementalMemory"     type="string" value="true"/>

      <!-- Keep raw sensor data. Only useful to save loop closure computation time 
           when features re-extraction is enabled. Disable to save RAM memory. -->
      <param name="Mem/ImageKept"           type="bool" value="true"/>
      <!-- Save depth image into 16 bits format to reduce memory used. Warning: 
           values over ~65 meters are ignored (maximum 65535 millimeters). -->
      <param name="Mem/SaveDepth16Format"   type="bool" value="true"/>      
    </node>
  </group> <!-- rtabmap_namespace -->
</launch>